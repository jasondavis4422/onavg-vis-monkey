<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monkey Brain Vertex Tracker – Reverse Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      background-color: black;
      color: white;
    }
    #page-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #upload-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 50;
    }
    #main-content {
      display: flex;
      flex: 1;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }
    #brain-image {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
      }
    #table-container {
      position: fixed;
      bottom: 150px;
      left: 10px;
      font-size: 12px;
      background-color: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 40;
    }
    #table-container table { border-collapse: collapse; }
    #table-container th,
    #table-container td {
      border: .5px solid white;
      padding: 4px;
      text-align: center;
    }
    #info-container {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 60;
    }
    #homepage-button {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 100;
    }
    #homepage-button button {
      padding: 8px 12px;
      background:#4682b4;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-size:14px;
    }
   /* NEW: panel placed at the top‑right corner */
#search-panel {
  position: fixed;
  top: 10px;
  right: 120px;               /* keep space from the "Instructions" button */
  background-color: rgba(0,0,0,0.8);
  padding: 8px;
  border-radius: 5px;
  font-size: 14px;
  z-index: 90;
}
#search-panel label,
#search-panel select,
#search-panel input,
#search-panel button {
  margin-right: 6px;
}

/* NEW: green circle that marks the vertex */
.vertex-marker {
  position: absolute;
  width: 14px;
  height: 14px;
  background: rgba(0,255,0,0.6);
  border: 2px solid #0f0;
  border-radius: 50%;
  pointer-events: none;   /* let mouse events pass through */
  transform: translate(-50%, -50%); /* centre the circle on the coordinate */
  z-index: 80;
}
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

  <!-- Home‑page link -->
  <div id="homepage-button">
    <a href="instructions.html"><button>Instructions</button></a>
  </div>

  <!-- ----- NEW: Search panel ----- -->
  <div id="search-panel">
    <label for="ico-select">ICO space:</label>
    <select id="ico-select">
      <option value="ico8">ico8</option>
      <option value="ico16">ico16</option>
      <option value="ico32">ico32</option>
      <option value="MEBRAIN">MEBRAIN</option>
    </select>

    <label for="vertex-input">Vertex index:</label>
    <input type="number" id="vertex-input" min="0" placeholder="e.g. 123" />

    <button id="show-vertex-btn">Show</button>
  </div>

  <!-- File upload controls -->
  <div id="upload-container">
    <label for="imageUpload">Choose Monkey Brain Image File:</label>
    <input type="file" id="imageUpload" accept="image/*" />
    <br /><br />
    <label for="dataUpload">Choose Monkey Data File in TXT format:</label>
    <input type="file" id="dataUpload" accept=".txt" />
  </div>

  <div id="page-container">
    <div id="main-content">
      <div id="table-container">
        <table>
          <thead>
            <tr><th></th><th>LH</th><th>RH</th></tr>
          </thead>
          <tbody>
            <tr><td>ico8</td><td>0-622</td><td>623-1243</td></tr>
            <tr><td>ico16</td><td>0-2484</td><td>2485-4968</td></tr>
            <tr><td>ico32</td><td>0-9929</td><td>9930-19862</td></tr>
            <tr><td>MEBRAIN</td><td>0-98022</td><td>98023-196069</td></tr>
          </tbody>
        </table>
      </div>
      <img id="brain-image" src="_static/ico8brain.png" alt="Brain Image" />
    </div>

    <div id="info-container">
      <p id="file-name"></p>
      <p id="vertex-info">
        Hover over the image to see vertex information. Each vertex contains
        the relevant numerical and string‑labeled parcel in the monkey brain.
      </p>
    </div>
  </div>

  <script>
    /* ==============================================================
       GLOBAL VARIABLES – same as the original script
       ============================================================== */
    let mappingData = null,
        lookupTableIco8 = null,
        lookupTableIco16 = null,
        lookupTableIco32 = null,
        lookupTableIcoME = null,
        dataMatrix = null,
        currentIcoSpace = null,
        ds128_aparc = null,
        ds128_aparc_a2009s = null,
        ds128_aparc_DKTatlas = null,
        destrieux_aparc = null,
        dk_aparc = null,
        dkt_aparc = null,
        originalWidth = 0,
        originalHeight = 0,
        scaleX = 1,
        scaleY = 1;

    const $image       = $('#brain-image');
    const $vertexInfo  = $('#vertex-info');
    const $fileName    = $('#file-name');

    /* --------------------------------------------------------------
       Utility functions (unchanged from the original)
       -------------------------------------------------------------- */
    function determineIcoSpace(len) {
      switch(len){
        case 1244:   return 'ico8';
        case 4969:   return 'ico16';
        case 19863:  return 'ico32';
        case 190070: return 'MEBRAIN';
        default:     return null;
      }
    }
    function getLookupTable(ico){
      switch(ico){
        case 'ico8':    return lookupTableIco8;
        case 'ico16':   return lookupTableIco16;
        case 'ico32':   return lookupTableIco32;
        case 'MEBRAIN': return lookupTableIcoME;
        default:        return null;
      }
    }
    function displayFileName(){
      const name = $image.attr('src').split('/').pop();
      $fileName.text(`File: ${name}`);
    }

    function updateDisplaySize(){
      const rect = $image[0].getBoundingClientRect();
      const dispW = rect.width, dispH = rect.height;
      scaleX = originalWidth / dispW;
      scaleY = originalHeight / dispH;
      console.log(scaleX, scaleY)
    }
    function getVertexFromMapping(mx, my){
      if (my>=0 && my<originalHeight && mx>=0 && mx<originalWidth){
        const v = mappingData[my][mx];
        return v!==-1 ? v : null;
      }
      return null;
    }

      // Load all JSON files
      function loadData() {
        $.when(
          $.getJSON('_static/mapping_data_icoME.json', data => {
            mappingData = data;
            originalHeight = mappingData.length;
            console.log("Height:", originalHeight);
            originalWidth = mappingData[0].length;
            console.log("Width:", originalWidth);
            console.log(`Mapping data loaded: (${originalWidth} x ${originalHeight})`);
          }),
          $.getJSON('_static/lookup_table_monkey_ico8.json', data => {
            lookupTableIco8 = data;
            console.log('Lookup table ico8 loaded');
          }),
          $.getJSON('_static/lookup_table_monkey_ico16.json', data => {
            lookupTableIco16 = data;
            console.log('Lookup table ico16 loaded');
          }),
          $.getJSON('_static/lookup_table_monkey_ico32.json', data => {
            lookupTableIco32 = data;
            console.log('Lookup table ico32 loaded');
          }),
          $.getJSON('_static/lookup_table_monkey_icoME.json', data => {
            lookupTableIcoME = data;
            console.log('Lookup table MEBRAIN loaded');
          }),
          $.getJSON('_static/ds128_aparc.json', data => {
            ds128_aparc = data;
            console.log('DS128 aparc loaded');
          }),
          $.getJSON('_static/ds128_aparc.a2009s.json', data => {
            ds128_aparc_a2009s = data;
            console.log('DS128 aparc.a2009s loaded');
          }),
          $.getJSON('_static/ds128_aparc.DKTatlas.json', data => {
            ds128_aparc_DKTatlas = data;
            console.log('DS128 aparc.DKTatlas loaded');
          }),
          $.getJSON('_static/destrieux_labels.json', data => {
            destrieux_aparc = data;
            console.log('Destrieux labels loaded');
          }),
          $.getJSON('_static/dk_labels.json', data => {
            dk_aparc = data;
            console.log('DK labels loaded');
          }),
          $.getJSON('_static/dkt_labels.json', data => {
            dkt_aparc = data;
            console.log('DKT labels loaded');
          })
        ).done(() => {
          console.log('All JSON files loaded successfully.');
          updateDisplaySize();
        });
      }
    /* --------------------------------------------------------------
       NEW HELPERS – reverse lookup from vertex → (x,y)
       -------------------------------------------------------------- */
    /**
     * Scan the mapping table for the first pixel that contains the requested
     * vertex and return its original image coordinates.
     * This is the only way to get pixel‑space coordinates because the
     * mapping table stores **vertex → pixel** information.
     */
    function getVertexCoordinates(vertex){
      for (let y=0; y<originalHeight; y++){
        const row = mappingData[y];
        for (let x=0; x<originalWidth; x++){
          if (row[x]===vertex){
            return [x, y];          // original (full‑resolution) coords
          }
        }
      }
      return null;                 // vertex not present (e.g. background)
    }

    /**
     * Validate that the entered vertex exists in the chosen ICO space.
     * The lookup tables are arrays where the *index* is the vertex number.
     */
    function validateVertex(icoSpace, vertex) {
      const table = getLookupTable(icoSpace);
      console.log(table)
      console.log(table.indexOf(vertex))
      if (table.includes(vertex)) {
        console.log(`The number ${vertex} is in the table data.`);
      } else {
        console.log(`The number ${vertex} is not found.`);

      const index = table.indexOf(vertex);
      console.log(index)

      if (index !== -1) {
          console.log(`The location (index) of ${vertex} is: ${index}`);
        } else {
          console.log(`${vertex} was not found in the array.`);
        }
      }
      return table && vertex >= 0 && vertex < table.length ? vertex : null;
    }

    /**
     * Draw (or redraw) the green circle at the supplied screen coordinates.
     */
    function drawMarker(xScreen, yScreen){
      $('.vertex-marker').remove();            // delete any previous marker
      const $m = $('<div class="vertex-marker"></div>');
      const imgOffset = $image.offset();
      $m.css({ left: imgOffset.left + xScreen,
               top:  imgOffset.top  + yScreen });
      $('body').append($m);
    }

    

    /* --------------------------------------------------------------
       UI – file uploads
       -------------------------------------------------------------- */
    $('#imageUpload').on('change', e=>{
      const file = e.target.files[0];
      if (file){
        $fileName.text(`File: ${file.name}`);
        const url = URL.createObjectURL(file);
        $image.attr('src',url).on('load', updateDisplaySize);
      }
    });

    $('#dataUpload').on('change', e=>{
      const file = e.target.files[0];
      if (file){
        $fileName.text(`Data Matrix File: ${file.name}`);
        const reader = new FileReader();
        reader.onload = ev=>{
          try{
            const txt = ev.target.result;
            dataMatrix = txt.replace(/\n/g,'')
                            .replace(/[\[\]]/g,'')
                            .split(',')
                            .map(v=>v.trim())
                            .filter(v=>v.length>0)
                            .map(v=>parseFloat(v));
            const len = dataMatrix.length;
            currentIcoSpace = determineIcoSpace(len);
            if (!currentIcoSpace){
              console.error('Unexpected data‑matrix length:',len);
            }
          }catch(err){
            console.error('Error parsing TXT file:',err);
          }
        };
        reader.readAsText(file);
      }
    });

    /* --------------------------------------------------------------
       UI – reverse‑lookup button
       -------------------------------------------------------------- */
    $('#show-vertex-btn').on('click', ()=>{
      const ico   = $('#ico-select').val();
      const vStr  = $('#vertex-input').val();

      // ---- basic validation -------------------------------------------------
      if (vStr==='' || isNaN(vStr)){
        alert('Please type a numeric vertex index.');
        return;
      }
      const vertex = parseInt(vStr,10);
      if (validateVertex(ico, vertex)===null){
        alert(`Vertex ${vertex} is not valid for ${ico}.`);
        return;
      }

      // ---- find original (x,y) in the mapping table ------------------------
      const coords = getVertexCoordinates(vertex);
      if (!coords){
        alert(`Vertex ${vertex} does not appear in the mapping image.`);
        return;
      }
      const [origX, origY] = coords;

      // ---- convert to screen coordinates (respect current zoom/size) -------
      const screenX = Math.round(origX / scaleX);
      const screenY = Math.round(origY / scaleY);

      // ---- draw the green circle -------------------------------------------
      drawMarker(screenX, screenY);
    });

    /* --------------------------------------------------------------
       Existing hover‑info (unchanged – still useful)
       -------------------------------------------------------------- */
    $image.on('mousemove', e=>{
      const rect = $image[0].getBoundingClientRect();
      const x = e.clientX - rect.left,
            y = e.clientY - rect.top;
      if (x<0||y<0||x>rect.width||y>rect.height){ $vertexInfo.text('No vertex selected');return; }

      const mx = Math.floor(x * scaleX),
            my = Math.floor(y * scaleY);
      const vertex = getVertexFromMapping(mx,my);

      if (vertex===null){
        $vertexInfo.text('No vertex selected');
        return;
      }

      // Grab values from the lookup tables (as in the original script)
      const ico8  = lookupTableIco8[vertex];
      const ico16 = lookupTableIco16[vertex];
      const ico32 = lookupTableIco32[vertex];
      const icoME = lookupTableIcoME[vertex];

      // Data‑matrix value for the *currently* loaded ICO space
      let dataValue = 'N/A';
      if (dataMatrix && currentIcoSpace){
        const lt = getLookupTable(currentIcoSpace);
        if (lt){
          const idx = lt[vertex];
          dataValue = dataMatrix[idx] !== undefined ? dataMatrix[idx] : 'N/A';
        }
      }

      const html = `
        <br><strong>onavg coordinate:</strong><br>
        ico8: ${ico8}<br>
        ico16: ${ico16}<br>
        ico32: ${ico32}<br>
        MEBRAIN: ${icoME}<br><br>
        <strong>Data Matrix Value in ${currentIcoSpace||'—'} space:</strong><br>
        value: ${dataValue}<br><br>
      `;
      $vertexInfo.html(html);
    });

    $image.on('mouseleave',()=>{ $vertexInfo.text('No vertex selected'); });

    /* --------------------------------------------------------------
       Initialise everything
       -------------------------------------------------------------- */
    $(document).ready(()=>{
      displayFileName();
      loadData();
      $(window).on('resize', updateDisplaySize);
    });
  </script>
</body>
</html>